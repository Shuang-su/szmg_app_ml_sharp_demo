<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é™€èºä»ªæµ‹è¯•</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(180deg, #1a1a2e 0%, #0a0a1a 100%);
            color: white;
            min-height: 100vh;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            padding: 20px 0;
        }
        
        h1 {
            font-size: 24px;
            margin-bottom: 10px;
        }
        
        .subtitle {
            font-size: 14px;
            color: rgba(255,255,255,0.7);
        }
        
        .permission-btn {
            display: block;
            width: 100%;
            max-width: 300px;
            margin: 30px auto;
            padding: 16px 32px;
            font-size: 18px;
            font-weight: 600;
            color: white;
            background: linear-gradient(135deg, #e91e63, #ff6090);
            border: none;
            border-radius: 30px;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(233, 30, 99, 0.4);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .permission-btn:active {
            transform: scale(0.98);
        }
        
        .permission-btn:disabled {
            background: #666;
            box-shadow: none;
        }
        
        .status-box {
            background: rgba(255,255,255,0.1);
            border-radius: 16px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .status-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #ff5252;
        }
        
        .status-dot.active {
            background: #4caf50;
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .data-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
        }
        
        .data-item {
            background: rgba(0,0,0,0.3);
            border-radius: 12px;
            padding: 16px;
            text-align: center;
        }
        
        .data-label {
            font-size: 12px;
            color: rgba(255,255,255,0.6);
            margin-bottom: 8px;
        }
        
        .data-value {
            font-size: 24px;
            font-weight: 600;
            color: #e91e63;
        }
        
        .visualizer {
            width: 200px;
            height: 200px;
            margin: 30px auto;
            position: relative;
            background: rgba(0,0,0,0.3);
            border-radius: 50%;
            border: 2px solid rgba(255,255,255,0.2);
        }
        
        .indicator {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 20px;
            height: 20px;
            margin: -10px 0 0 -10px;
            background: linear-gradient(135deg, #e91e63, #ff6090);
            border-radius: 50%;
            box-shadow: 0 0 20px rgba(233, 30, 99, 0.6);
            transition: transform 0.1s ease-out;
        }
        
        .center-mark {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 10px;
            height: 10px;
            margin: -5px 0 0 -5px;
            background: rgba(255,255,255,0.3);
            border-radius: 50%;
        }
        
        .crosshair {
            position: absolute;
            background: rgba(255,255,255,0.1);
        }
        
        .crosshair.h {
            top: 50%;
            left: 10%;
            right: 10%;
            height: 1px;
        }
        
        .crosshair.v {
            left: 50%;
            top: 10%;
            bottom: 10%;
            width: 1px;
        }
        
        .log-box {
            background: rgba(0,0,0,0.5);
            border-radius: 12px;
            padding: 16px;
            margin-top: 20px;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        
        .log-entry {
            padding: 4px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .log-entry.error {
            color: #ff5252;
        }
        
        .log-entry.success {
            color: #4caf50;
        }
        
        .log-entry.info {
            color: #2196f3;
        }
        
        .tips {
            background: rgba(33, 150, 243, 0.2);
            border-left: 4px solid #2196f3;
            padding: 16px;
            margin: 20px 0;
            border-radius: 0 12px 12px 0;
            font-size: 14px;
            line-height: 1.6;
        }
        
        .reset-btn {
            display: block;
            width: 100%;
            max-width: 200px;
            margin: 20px auto;
            padding: 12px 24px;
            font-size: 14px;
            color: white;
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 20px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ“± é™€èºä»ªæµ‹è¯•</h1>
        <p class="subtitle">æµ‹è¯•è®¾å¤‡é™€èºä»ªåŠŸèƒ½å’Œæƒé™è¯·æ±‚</p>
    </div>
    
    <div class="tips">
        <strong>ğŸ’¡ ä½¿ç”¨è¯´æ˜ï¼š</strong><br>
        1. ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®è¯·æ±‚é™€èºä»ªæƒé™<br>
        2. iOS è®¾å¤‡ä¼šå¼¹å‡ºæƒé™è¯·æ±‚å¯¹è¯æ¡†<br>
        3. å…è®¸åå€¾æ–œæ‰‹æœºæŸ¥çœ‹æ•°æ®å˜åŒ–<br>
        4. ç²‰è‰²åœ†ç‚¹ä¼šè·Ÿéšæ‰‹æœºå€¾æ–œç§»åŠ¨
    </div>
    
    <button class="permission-btn" id="permissionBtn">
        ğŸ”“ è¯·æ±‚é™€èºä»ªæƒé™
    </button>
    
    <div class="status-box">
        <div class="status-title">
            <span class="status-dot" id="statusDot"></span>
            <span id="statusText">ç­‰å¾…è¯·æ±‚æƒé™...</span>
        </div>
        
        <div class="data-grid">
            <div class="data-item">
                <div class="data-label">Alpha (Î±)</div>
                <div class="data-value" id="alpha">--</div>
            </div>
            <div class="data-item">
                <div class="data-label">Beta (Î²)</div>
                <div class="data-value" id="beta">--</div>
            </div>
            <div class="data-item">
                <div class="data-label">Gamma (Î³)</div>
                <div class="data-value" id="gamma">--</div>
            </div>
        </div>
    </div>
    
    <div class="visualizer">
        <div class="crosshair h"></div>
        <div class="crosshair v"></div>
        <div class="center-mark"></div>
        <div class="indicator" id="indicator"></div>
    </div>
    
    <button class="reset-btn" id="resetBtn">ğŸ”„ é‡ç½®åˆå§‹ä½ç½®</button>
    
    <div class="log-box" id="logBox"></div>
    
    <script>
        // DOM å…ƒç´ 
        const permissionBtn = document.getElementById('permissionBtn');
        const statusDot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');
        const alphaEl = document.getElementById('alpha');
        const betaEl = document.getElementById('beta');
        const gammaEl = document.getElementById('gamma');
        const indicator = document.getElementById('indicator');
        const logBox = document.getElementById('logBox');
        const resetBtn = document.getElementById('resetBtn');
        
        // çŠ¶æ€
        let permissionGranted = false;
        let initialGyro = null;
        let eventCount = 0;
        
        // æ—¥å¿—
        function log(message, type = 'info') {
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logBox.insertBefore(entry, logBox.firstChild);
            console.log(message);
        }
        
        // æ£€æµ‹è®¾å¤‡ä¿¡æ¯
        function detectDevice() {
            const ua = navigator.userAgent;
            const isIOS = /iPad|iPhone|iPod/.test(ua);
            const isAndroid = /Android/.test(ua);
            const isSafari = /Safari/.test(ua) && !/Chrome/.test(ua);
            const isSecure = location.protocol === 'https:' || location.hostname === 'localhost' || location.hostname === '127.0.0.1';
            
            log(`è®¾å¤‡: ${isIOS ? 'iOS' : isAndroid ? 'Android' : 'å…¶ä»–'}`);
            log(`æµè§ˆå™¨: ${isSafari ? 'Safari' : 'Chrome/å…¶ä»–'}`);
            log(`åè®®: ${location.protocol}`);
            log(`å®‰å…¨ä¸Šä¸‹æ–‡: ${isSecure ? 'æ˜¯' : 'å¦ (éœ€è¦HTTPS!)'}`);
            log(`DeviceOrientationEvent: ${typeof DeviceOrientationEvent}`);
            log(`requestPermission: ${typeof DeviceOrientationEvent?.requestPermission}`);
            
            // è­¦å‘Šï¼šä¸æ˜¯å®‰å…¨ä¸Šä¸‹æ–‡
            if (!isSecure && isIOS) {
                log('âš ï¸ iOS éœ€è¦ HTTPS æ‰èƒ½ä½¿ç”¨é™€èºä»ª!', 'error');
                statusText.textContent = 'éœ€è¦ HTTPS è¿æ¥';
                
                // æ˜¾ç¤ºæç¤º
                const tip = document.querySelector('.tips');
                tip.innerHTML = `
                    <strong>âš ï¸ é‡è¦ï¼šiOS è®¾å¤‡éœ€è¦ HTTPS</strong><br><br>
                    å½“å‰ä½¿ç”¨ HTTP åè®®ï¼ŒiOS Safari ä¸å…è®¸è®¿é—®é™€èºä»ªã€‚<br><br>
                    <strong>è§£å†³æ–¹æ¡ˆï¼š</strong><br>
                    1. ä½¿ç”¨ ngrok æˆ–å…¶ä»–éš§é“å·¥å…·åˆ›å»º HTTPS é“¾æ¥<br>
                    2. æˆ–è€…åœ¨ Mac Safari ä¸Šè°ƒè¯•ï¼ˆä¸éœ€è¦ HTTPSï¼‰<br>
                    3. æˆ–è€…éƒ¨ç½²åˆ°æ”¯æŒ HTTPS çš„æœåŠ¡å™¨
                `;
                tip.style.background = 'rgba(255, 82, 82, 0.2)';
                tip.style.borderColor = '#ff5252';
            }
        }
        
        // è¯·æ±‚æƒé™
        async function requestPermission() {
            log('å¼€å§‹è¯·æ±‚é™€èºä»ªæƒé™...', 'info');
            
            // æ£€æŸ¥æ˜¯å¦æ”¯æŒ
            if (!window.DeviceOrientationEvent) {
                log('è®¾å¤‡ä¸æ”¯æŒ DeviceOrientationEvent', 'error');
                statusText.textContent = 'è®¾å¤‡ä¸æ”¯æŒé™€èºä»ª';
                return;
            }
            
            // iOS 13+ éœ€è¦æ˜¾å¼è¯·æ±‚æƒé™
            if (typeof DeviceOrientationEvent.requestPermission === 'function') {
                try {
                    log('æ£€æµ‹åˆ° iOS 13+ï¼Œè¯·æ±‚æƒé™...', 'info');
                    const permission = await DeviceOrientationEvent.requestPermission();
                    log(`æƒé™ç»“æœ: ${permission}`, permission === 'granted' ? 'success' : 'error');
                    
                    if (permission === 'granted') {
                        permissionGranted = true;
                        enableGyroscope();
                    } else {
                        statusText.textContent = 'æƒé™è¢«æ‹’ç»';
                        statusDot.classList.remove('active');
                    }
                } catch (error) {
                    log(`æƒé™è¯·æ±‚é”™è¯¯: ${error.message}`, 'error');
                    statusText.textContent = 'æƒé™è¯·æ±‚å¤±è´¥: ' + error.message;
                }
            } else {
                // Android æˆ–æ—§ç‰ˆ iOS
                log('æ— éœ€æ˜¾å¼è¯·æ±‚æƒé™ï¼Œç›´æ¥å¯ç”¨...', 'info');
                permissionGranted = true;
                enableGyroscope();
            }
        }
        
        // å¯ç”¨é™€èºä»ª
        function enableGyroscope() {
            log('æ·»åŠ  deviceorientation äº‹ä»¶ç›‘å¬...', 'info');
            
            window.addEventListener('deviceorientation', handleOrientation, true);
            
            // æ£€æµ‹æ˜¯å¦çœŸçš„æœ‰æ•°æ®
            setTimeout(() => {
                if (eventCount === 0) {
                    log('è­¦å‘Š: 3ç§’å†…æœªæ”¶åˆ°é™€èºä»ªæ•°æ®', 'error');
                    statusText.textContent = 'æœªæ£€æµ‹åˆ°é™€èºä»ªæ•°æ®';
                }
            }, 3000);
            
            permissionBtn.textContent = 'âœ… æƒé™å·²è·å–';
            permissionBtn.disabled = true;
            statusText.textContent = 'ç­‰å¾…é™€èºä»ªæ•°æ®...';
            statusDot.classList.add('active');
        }
        
        // å¤„ç†é™€èºä»ªæ•°æ®
        function handleOrientation(event) {
            eventCount++;
            
            // é¦–æ¬¡æ”¶åˆ°æ•°æ®
            if (eventCount === 1) {
                log('é¦–æ¬¡æ”¶åˆ°é™€èºä»ªæ•°æ®!', 'success');
                statusText.textContent = 'é™€èºä»ªå·¥ä½œæ­£å¸¸';
            }
            
            const { alpha, beta, gamma } = event;
            
            // æ£€æŸ¥æ•°æ®æœ‰æ•ˆæ€§
            if (beta === null || gamma === null) {
                if (eventCount < 5) {
                    log('æ”¶åˆ°ç©ºæ•°æ®: beta/gamma ä¸º null', 'error');
                }
                return;
            }
            
            // è®°å½•åˆå§‹ä½ç½®
            if (!initialGyro) {
                initialGyro = { alpha, beta, gamma };
                log(`è®°å½•åˆå§‹ä½ç½®: Î±=${alpha?.toFixed(1)}, Î²=${beta.toFixed(1)}, Î³=${gamma.toFixed(1)}`, 'success');
            }
            
            // æ›´æ–°æ˜¾ç¤º
            alphaEl.textContent = alpha?.toFixed(1) || '--';
            betaEl.textContent = beta.toFixed(1);
            gammaEl.textContent = gamma.toFixed(1);
            
            // è®¡ç®—ç›¸å¯¹åç§»
            const deltaX = (gamma - initialGyro.gamma);
            const deltaY = (beta - initialGyro.beta);
            
            // æ›´æ–°æŒ‡ç¤ºå™¨ä½ç½® (é™åˆ¶åœ¨åœ†å½¢èŒƒå›´å†…)
            const maxOffset = 80;
            const x = Math.max(-maxOffset, Math.min(maxOffset, deltaX * 2));
            const y = Math.max(-maxOffset, Math.min(maxOffset, deltaY * 2));
            
            indicator.style.transform = `translate(${x}px, ${y}px)`;
        }
        
        // é‡ç½®åˆå§‹ä½ç½®
        function resetInitialPosition() {
            initialGyro = null;
            log('å·²é‡ç½®åˆå§‹ä½ç½®', 'info');
        }
        
        // åˆå§‹åŒ–
        function init() {
            detectDevice();
            
            permissionBtn.addEventListener('click', requestPermission);
            resetBtn.addEventListener('click', resetInitialPosition);
            
            log('é¡µé¢åˆå§‹åŒ–å®Œæˆï¼Œè¯·ç‚¹å‡»æŒ‰é’®è¯·æ±‚æƒé™', 'info');
        }
        
        init();
    </script>
</body>
</html>
