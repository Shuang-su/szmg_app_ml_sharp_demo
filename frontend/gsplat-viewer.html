<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç©ºé—´è§†å·®ä½“éªŒ - Spatial News Demo</title>
    <script type="importmap">
        {
            "imports": {
                "playcanvas": "https://esm.run/playcanvas@2.5.0"
            }
        }
    </script>
    <style>
        :root {
            --primary-color: #e91e63;
            --primary-light: #ff6090;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'PingFang SC', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #000;
            color: white;
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 56px;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(20px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .header h1 {
            font-size: 17px;
            font-weight: 500;
        }
        
        .back-btn {
            position: absolute;
            left: 16px;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            text-decoration: none;
        }
        
        /* æ²‰æµ¸å¼è‹±é›„åŒºåŸŸ */
        .hero {
            height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 0 24px;
            background: linear-gradient(180deg, #0a0a1a 0%, #000 100%);
        }
        
        .hero h2 {
            font-size: 48px;
            font-weight: 700;
            margin-bottom: 16px;
            background: linear-gradient(135deg, #fff 0%, rgba(255,255,255,0.6) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .hero p {
            font-size: 18px;
            color: rgba(255,255,255,0.6);
            max-width: 500px;
            line-height: 1.6;
        }
        
        .scroll-hint {
            position: absolute;
            bottom: 40px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            color: rgba(255,255,255,0.4);
            font-size: 13px;
            animation: bounce 2s infinite;
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(8px); }
        }
        
        /* å†…å®¹åŒºå— */
        .section {
            padding: 80px 24px;
            max-width: 800px;
            margin: 0 auto;
        }
        
        .section-text {
            text-align: center;
            margin-bottom: 48px;
        }
        
        .section-text h3 {
            font-size: 32px;
            font-weight: 600;
            margin-bottom: 16px;
        }
        
        .section-text p {
            font-size: 17px;
            color: rgba(255,255,255,0.6);
            line-height: 1.7;
            max-width: 600px;
            margin: 0 auto;
        }
        
        /* 3Dæ¨¡å‹å®¹å™¨ */
        .splat-section {
            position: relative;
            width: 100%;
            margin: 40px 0;
        }
        
        .splat-container {
            position: relative;
            width: 100%;
            aspect-ratio: 16/10;
            background: radial-gradient(ellipse at center, #1a1a2e 0%, #0a0a0a 100%);
            border-radius: 24px;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        }
        
        .splat-canvas {
            width: 100%;
            height: 100%;
            display: block;
        }
        
        .splat-loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 2px solid rgba(255,255,255,0.1);
            border-top-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .loading-text {
            margin-top: 12px;
            font-size: 13px;
            color: rgba(255,255,255,0.5);
        }
        
        .splat-caption {
            text-align: center;
            margin-top: 16px;
            font-size: 14px;
            color: rgba(255,255,255,0.4);
        }
        
        .hidden {
            display: none !important;
        }
        
        /* åˆ†éš”æ–‡å­—åŒºåŸŸ */
        .divider-section {
            padding: 120px 24px;
            text-align: center;
            background: linear-gradient(180deg, #000 0%, #0a0a1a 50%, #000 100%);
        }
        
        .divider-section h3 {
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 20px;
            color: rgba(255,255,255,0.9);
        }
        
        .divider-section p {
            font-size: 16px;
            color: rgba(255,255,255,0.5);
            line-height: 1.8;
            max-width: 500px;
            margin: 0 auto;
        }
        
        /* ç‰¹æ€§å¡ç‰‡ */
        .feature-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            margin-top: 48px;
        }
        
        .feature-card {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 16px;
            padding: 24px;
            text-align: left;
        }
        
        .feature-card .icon {
            font-size: 28px;
            margin-bottom: 12px;
        }
        
        .feature-card h4 {
            font-size: 15px;
            margin-bottom: 8px;
        }
        
        .feature-card p {
            font-size: 13px;
            color: rgba(255,255,255,0.5);
            line-height: 1.5;
        }
        
        /* åº•éƒ¨æ§åˆ¶é¢æ¿ */
        .controls-section {
            padding: 60px 24px 120px;
            max-width: 600px;
            margin: 0 auto;
        }
        
        .controls-panel {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
        }
        
        .controls-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 16px;
            color: rgba(255,255,255,0.8);
        }
        
        .control-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 14px;
        }
        
        .control-row:last-child {
            margin-bottom: 0;
        }
        
        .control-label {
            font-size: 13px;
            color: rgba(255,255,255,0.6);
        }
        
        .control-slider {
            width: 100px;
            accent-color: var(--primary-color);
        }
        
        .control-value {
            font-size: 12px;
            color: var(--primary-color);
            min-width: 40px;
            text-align: right;
        }
        
        .toggle-switch {
            position: relative;
            width: 44px;
            height: 24px;
            background: rgba(255,255,255,0.15);
            border-radius: 12px;
            cursor: pointer;
            transition: background 0.3s ease;
        }
        
        .toggle-switch.active {
            background: var(--primary-color);
        }
        
        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s ease;
        }
        
        .toggle-switch.active::after {
            transform: translateX(20px);
        }
        
        .reset-btn {
            padding: 10px 16px;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            color: white;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .reset-btn:hover {
            background: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        /* é¡µè„š */
        .footer {
            text-align: center;
            padding: 40px 24px 100px;
            color: rgba(255,255,255,0.3);
            font-size: 13px;
        }
        
        /* å“åº”å¼ */
        @media (max-width: 600px) {
            .hero h2 {
                font-size: 32px;
            }
            
            .hero p {
                font-size: 15px;
            }
            
            .section-text h3 {
                font-size: 24px;
            }
            
            .feature-grid {
                grid-template-columns: 1fr;
            }
            
            .divider-section h3 {
                font-size: 22px;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <a href="index.html" class="back-btn">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M15 18l-6-6 6-6"/>
            </svg>
        </a>
        <h1>ç©ºé—´è§†å·®ä½“éªŒ</h1>
    </header>

    <!-- è‹±é›„åŒºåŸŸ -->
    <section class="hero">
        <h2>æ²‰æµ¸å¼ç©ºé—´</h2>
        <p>é€šè¿‡é«˜æ–¯æ³¼æº…æŠ€æœ¯ï¼Œæ„Ÿå—ç…§ç‰‡ä»å¹³é¢è·ƒå…¥ä¸‰ç»´çš„ç¥å¥‡æ—¶åˆ»ã€‚æ»šåŠ¨é¡µé¢ï¼Œæ¢ç´¢ç©ºé—´è§†å·®çš„é­…åŠ›ã€‚</p>
        <div class="scroll-hint">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <path d="M12 5v14M19 12l-7 7-7-7"/>
            </svg>
            <span>å‘ä¸‹æ»šåŠ¨</span>
        </div>
    </section>

    <!-- ç¬¬ä¸€ä¸ªæ¨¡å‹ -->
    <section class="section">
        <div class="section-text">
            <h3>æ•æ‰ç¬é—´çš„æ·±åº¦</h3>
            <p>æ¯ä¸€å¼ ç…§ç‰‡éƒ½è•´å«ç€ç©ºé—´ä¿¡æ¯ã€‚é€šè¿‡å…ˆè¿›çš„3Dé‡å»ºæŠ€æœ¯ï¼Œæˆ‘ä»¬å°†è¿™äº›éšè—çš„ç»´åº¦é‡Šæ”¾å‡ºæ¥ï¼Œåˆ›é€ å‡ºèº«ä¸´å…¶å¢ƒçš„è§‚çœ‹ä½“éªŒã€‚</p>
        </div>
        <div class="splat-section">
            <div class="splat-container" data-model="0">
                <canvas class="splat-canvas" id="canvas-0"></canvas>
                <div class="splat-loading" id="loading-0">
                    <div class="loading-spinner"></div>
                    <div class="loading-text">æ­£åœ¨åŠ è½½...</div>
                </div>
            </div>
            <p class="splat-caption">æ»šåŠ¨é¡µé¢ï¼Œè§‚å¯Ÿè§†è§’çš„å¾®å¦™å˜åŒ–</p>
        </div>
    </section>

    <!-- åˆ†éš”åŒºåŸŸ -->
    <section class="divider-section">
        <h3>é€è¿‡çª—æˆ·çœ‹ä¸–ç•Œ</h3>
        <p>å°±åƒé€è¿‡ä¸€æ‰‡ç¥å¥‡çš„çª—æˆ·ï¼Œä½ å¯ä»¥ä»ä¸åŒè§’åº¦çª¥æ¢å¦ä¸€ä¸ªç©ºé—´ã€‚è¿™ä¸ä»…ä»…æ˜¯è§‚çœ‹ï¼Œè€Œæ˜¯ä¸€ç§å…¨æ–°çš„æ„ŸçŸ¥æ–¹å¼ã€‚</p>
    </section>

    <!-- ç¬¬äºŒä¸ªæ¨¡å‹ -->
    <section class="section">
        <div class="section-text">
            <h3>è®°å¿†çš„æ–°ç»´åº¦</h3>
            <p>å½“ç…§ç‰‡æ‹¥æœ‰äº†æ·±åº¦ï¼Œå›å¿†ä¹Ÿå˜å¾—æ›´åŠ çœŸå®ã€‚æ¯ä¸€æ¬¡æµè§ˆï¼Œéƒ½æ˜¯ä¸€æ¬¡é‡å›ç°åœºçš„æ—…ç¨‹ã€‚</p>
        </div>
        <div class="splat-section">
            <div class="splat-container" data-model="1">
                <canvas class="splat-canvas" id="canvas-1"></canvas>
                <div class="splat-loading" id="loading-1">
                    <div class="loading-spinner"></div>
                    <div class="loading-text">æ­£åœ¨åŠ è½½...</div>
                </div>
            </div>
            <p class="splat-caption">å€¾æ–œæ‰‹æœºæˆ–ç§»åŠ¨é¼ æ ‡ï¼Œæ¢ç´¢æ›´å¤šè§’åº¦</p>
        </div>
    </section>

    <!-- ç‰¹æ€§ä»‹ç» -->
    <section class="section">
        <div class="section-text">
            <h3>æŠ€æœ¯ä¸è‰ºæœ¯çš„èåˆ</h3>
            <p>é«˜æ–¯æ³¼æº…ï¼ˆGaussian Splattingï¼‰æ˜¯ä¸€ç§é©å‘½æ€§çš„3Dè¡¨ç¤ºæ–¹æ³•ï¼Œå®ƒå°†åœºæ™¯è¡¨ç¤ºä¸ºæ•°ç™¾ä¸‡ä¸ªå°é«˜æ–¯ç‚¹ï¼Œå®ç°äº†å‰æ‰€æœªæœ‰çš„æ¸²æŸ“è´¨é‡å’Œé€Ÿåº¦ã€‚</p>
        </div>
        <div class="feature-grid">
            <div class="feature-card">
                <div class="icon">ğŸ¯</div>
                <h4>ç©ºé—´è§†å·®</h4>
                <p>æ ¹æ®å±å¹•ä½ç½®è‡ªåŠ¨è°ƒæ•´è§†è§’ï¼Œåˆ›é€ çª—å£æ•ˆæœ</p>
            </div>
            <div class="feature-card">
                <div class="icon">ğŸ“±</div>
                <h4>é™€èºä»ªæ§åˆ¶</h4>
                <p>å€¾æ–œè®¾å¤‡å³å¯ä»ä¸åŒè§’åº¦è§‚çœ‹åœºæ™¯</p>
            </div>
            <div class="feature-card">
                <div class="icon">âš¡</div>
                <h4>å®æ—¶æ¸²æŸ“</h4>
                <p>60fpsæµç•…ä½“éªŒï¼Œæ— éœ€ç­‰å¾…åŠ è½½</p>
            </div>
            <div class="feature-card">
                <div class="icon">ğŸ¨</div>
                <h4>ç…§ç‰‡çº§è´¨é‡</h4>
                <p>ä¿ç•™åŸå§‹ç…§ç‰‡çš„æ¯ä¸€ä¸ªç»†èŠ‚</p>
            </div>
        </div>
    </section>

    <!-- ç¬¬ä¸‰ä¸ªæ¨¡å‹ -->
    <section class="section">
        <div class="section-text">
            <h3>å…‰å½±çš„è¯—ç¯‡</h3>
            <p>å…‰çº¿åœ¨ç©ºé—´ä¸­æµè½¬ï¼Œæ¯ä¸€å¸§éƒ½æ˜¯ä¸€é¦–å…³äºå…‰ä¸å½±çš„è¯—ã€‚æ„Ÿå—é‚£äº›è¢«æ—¶é—´å®šæ ¼çš„ç¾å¥½ç¬é—´ã€‚</p>
        </div>
        <div class="splat-section">
            <div class="splat-container" data-model="2">
                <canvas class="splat-canvas" id="canvas-2"></canvas>
                <div class="splat-loading" id="loading-2">
                    <div class="loading-spinner"></div>
                    <div class="loading-text">æ­£åœ¨åŠ è½½...</div>
                </div>
            </div>
        </div>
    </section>

    <!-- åˆ†éš”åŒºåŸŸ -->
    <section class="divider-section">
        <h3>æœªæ¥å·²æ¥</h3>
        <p>è¿™åªæ˜¯å¼€å§‹ã€‚éšç€æŠ€æœ¯çš„è¿›æ­¥ï¼Œæˆ‘ä»¬å°†èƒ½å¤Ÿä»¥æ›´åŠ è‡ªç„¶çš„æ–¹å¼è®°å½•å’Œå›é¡¾ç”Ÿæ´»ä¸­çš„æ¯ä¸€ä¸ªé‡è¦æ—¶åˆ»ã€‚</p>
    </section>

    <!-- ç¬¬å››ä¸ªæ¨¡å‹ -->
    <section class="section">
        <div class="section-text">
            <h3>ç©ºé—´çš„å›å“</h3>
            <p>åœ¨è¿™é‡Œï¼Œå¹³é¢ä¸ç«‹ä½“çš„ç•Œé™å˜å¾—æ¨¡ç³Šã€‚ä½ æ‰€çœ‹åˆ°çš„ä¸ä»…æ˜¯å›¾åƒï¼Œæ›´æ˜¯ä¸€ä¸ªå¯ä»¥æ¢ç´¢çš„å¾®å‹ä¸–ç•Œã€‚</p>
        </div>
        <div class="splat-section">
            <div class="splat-container" data-model="3">
                <canvas class="splat-canvas" id="canvas-3"></canvas>
                <div class="splat-loading" id="loading-3">
                    <div class="loading-spinner"></div>
                    <div class="loading-text">æ­£åœ¨åŠ è½½...</div>
                </div>
            </div>
        </div>
    </section>

    <!-- æ§åˆ¶é¢æ¿ -->
    <section class="controls-section">
        <div class="controls-panel">
            <div class="controls-title">ğŸ® ä½“éªŒè®¾ç½®</div>
            
            <div class="control-row">
                <span class="control-label">é™€èºä»ªæ§åˆ¶</span>
                <div class="toggle-switch" id="gyro-toggle"></div>
            </div>
            
            <div class="control-row">
                <span class="control-label">è§†å·®å¼ºåº¦</span>
                <input type="range" class="control-slider" id="parallax-intensity" min="0.2" max="3" step="0.1" value="1">
                <span class="control-value" id="parallax-value">1.0</span>
            </div>
            
            <div class="control-row">
                <span class="control-label">æ»šåŠ¨è§†å·®å¼ºåº¦</span>
                <input type="range" class="control-slider" id="scroll-intensity" min="0.2" max="3" step="0.1" value="1">
                <span class="control-value" id="scroll-value">1.0</span>
            </div>
        </div>
        
        <div class="controls-panel">
            <div class="controls-title">ğŸ¥ ç›¸æœºè®¾ç½®</div>
            
            <div class="control-row">
                <span class="control-label">ç›¸æœºè·ç¦»</span>
                <input type="range" class="control-slider" id="camera-distance" min="1" max="10" step="0.5" value="3">
                <span class="control-value" id="distance-value">3.0</span>
            </div>
            
            <div class="control-row">
                <span class="control-label">ç›¸æœºä¿¯ä»°</span>
                <input type="range" class="control-slider" id="base-pitch" min="-90" max="90" step="1" value="0">
                <span class="control-value" id="base-pitch-value">0Â°</span>
            </div>
            
            <div class="control-row">
                <span class="control-label">ç›¸æœºåèˆª</span>
                <input type="range" class="control-slider" id="base-yaw" min="-180" max="180" step="5" value="0">
                <span class="control-value" id="base-yaw-value">0Â°</span>
            </div>
            
            <div class="control-row">
                <span class="control-label">è§†é‡è§’åº¦</span>
                <input type="range" class="control-slider" id="camera-fov" min="30" max="120" step="5" value="60">
                <span class="control-value" id="fov-value">60Â°</span>
            </div>
        </div>
        
        <div class="controls-panel">
            <div class="controls-title">ğŸ“ æ¨¡å‹ä½ç½®</div>
            
            <div class="control-row">
                <span class="control-label">Xè½´ä½ç½®</span>
                <input type="range" class="control-slider" id="model-offset-x" min="-5" max="5" step="0.1" value="0">
                <span class="control-value" id="offset-x-value">0.0</span>
            </div>
            
            <div class="control-row">
                <span class="control-label">Yè½´ä½ç½®ï¼ˆä¸Šä¸‹ï¼‰</span>
                <input type="range" class="control-slider" id="model-offset-y" min="-5" max="5" step="0.1" value="0.3">
                <span class="control-value" id="offset-y-value">0.3</span>
            </div>
            
            <div class="control-row">
                <span class="control-label">Zè½´ä½ç½®</span>
                <input type="range" class="control-slider" id="model-offset-z" min="-5" max="5" step="0.1" value="0">
                <span class="control-value" id="offset-z-value">0.0</span>
            </div>
        </div>
        
        <div class="controls-panel">
            <div class="controls-title">ğŸ”„ æ¨¡å‹æ—‹è½¬</div>
            
            <div class="control-row">
                <span class="control-label">Xè½´æ—‹è½¬ï¼ˆä¿¯ä»°ï¼‰</span>
                <input type="range" class="control-slider" id="model-rotation-x" min="0" max="360" step="5" value="180">
                <span class="control-value" id="rotation-x-value">180Â°</span>
            </div>
            
            <div class="control-row">
                <span class="control-label">Yè½´æ—‹è½¬ï¼ˆæ°´å¹³ï¼‰</span>
                <input type="range" class="control-slider" id="model-rotation-y" min="0" max="360" step="5" value="0">
                <span class="control-value" id="rotation-y-value">0Â°</span>
            </div>
            
            <div class="control-row">
                <span class="control-label">Zè½´æ—‹è½¬ï¼ˆå€¾æ–œï¼‰</span>
                <input type="range" class="control-slider" id="model-rotation-z" min="0" max="360" step="5" value="0">
                <span class="control-value" id="rotation-z-value">0Â°</span>
            </div>
        </div>
        
        <div class="controls-panel">
            <div class="controls-title">ğŸ”§ å¿«æ·æ“ä½œ</div>
            
            <div class="control-row" style="justify-content: center; gap: 12px;">
                <button class="reset-btn" id="reset-camera">é‡ç½®ç›¸æœº</button>
                <button class="reset-btn" id="reset-model">é‡ç½®æ¨¡å‹</button>
                <button class="reset-btn" id="reset-all">å…¨éƒ¨é‡ç½®</button>
            </div>
        </div>
    </section>

    <!-- é¡µè„š -->
    <footer class="footer">
        <p>Spatial Browsing Demo Â· Powered by PlayCanvas & Gaussian Splatting</p>
    </footer>

    <script type="module">
        import * as pc from 'playcanvas';

        // æ¨¡å‹åˆ—è¡¨ï¼ˆå»æ‰teaserå’Œæ¨¡å‹5ï¼‰
        const models = [
            { file: '0b55fab279dd46c49c6fc1a2182bf904.ply', name: 'æ¨¡å‹1' },
            { file: '1d57337aa0224addb86b35a744e79ea3.ply', name: 'æ¨¡å‹2' },
            { file: '2154c73695ce427087941ca58edcbe67.ply', name: 'æ¨¡å‹3' },
            { file: '3d325a6fefd545fb86977b8f01ce2fe7.ply', name: 'æ¨¡å‹4' }
        ];

        // å…¨å±€é…ç½®
        const config = {
            plyBasePath: '../output/',
            parallaxIntensity: 1.0,
            cameraDistance: 3.0,
            gyroEnabled: false,
            // æ¨¡å‹ä½ç½®
            modelOffsetX: 0,
            modelOffsetY: 0.3,  // é»˜è®¤ç¨å¾®å¾€ä¸Š
            modelOffsetZ: 0,
            // æ¨¡å‹æ—‹è½¬
            modelRotationX: 180,  // é«˜æ–¯æ³¼æº…é»˜è®¤éœ€è¦ç¿»è½¬
            modelRotationY: 0,
            modelRotationZ: 0,
            // ç›¸æœºè®¾ç½®
            basePitch: 0,
            baseYaw: 0,
            cameraFov: 60,
            // æ»šåŠ¨è§†å·®
            scrollParallaxIntensity: 1.0
        };

        // å­˜å‚¨æ¯ä¸ªæ¨¡å‹çš„å®ä¾‹
        const instances = [];

        // é™€èºä»ªç›¸å…³
        let gyroPermissionGranted = false;
        let gyroListenerAdded = false;
        let initialGyro = null;
        let gyroAngles = { pitch: 0, yaw: 0 };

        // åˆ›å»ºå•ä¸ªæ¨¡å‹å®ä¾‹
        async function createInstance(index) {
            const canvas = document.getElementById(`canvas-${index}`);
            const loadingEl = document.getElementById(`loading-${index}`);
            const container = canvas.closest('.splat-container');
            
            try {
                // åˆ›å»ºå›¾å½¢è®¾å¤‡
                const device = await pc.createGraphicsDevice(canvas, {
                    deviceTypes: ['webgl2', 'webgl1'],
                    antialias: false
                });
                device.maxPixelRatio = Math.min(window.devicePixelRatio, 2);

                // åˆ›å»ºåº”ç”¨
                const createOptions = new pc.AppOptions();
                createOptions.graphicsDevice = device;
                createOptions.mouse = new pc.Mouse(canvas);
                createOptions.touch = new pc.TouchDevice(canvas);
                createOptions.componentSystems = [
                    pc.RenderComponentSystem,
                    pc.CameraComponentSystem,
                    pc.LightComponentSystem,
                    pc.GSplatComponentSystem
                ];
                createOptions.resourceHandlers = [
                    pc.TextureHandler,
                    pc.ContainerHandler,
                    pc.GSplatHandler
                ];

                const app = new pc.AppBase(canvas);
                app.init(createOptions);
                app.setCanvasFillMode(pc.FILLMODE_FILL_WINDOW);
                app.setCanvasResolution(pc.RESOLUTION_AUTO);

                // åˆ›å»ºç›¸æœº
                const camera = new pc.Entity('camera');
                camera.addComponent('camera', {
                    clearColor: new pc.Color(0.04, 0.04, 0.06),
                    fov: 60,
                    nearClip: 0.1,
                    farClip: 1000
                });
                camera.setLocalPosition(0, 0, config.cameraDistance);
                app.root.addChild(camera);

                app.start();

                // åŠ è½½æ¨¡å‹
                const url = config.plyBasePath + models[index].file;
                const asset = new pc.Asset(models[index].file, 'gsplat', { url });

                await new Promise((resolve, reject) => {
                    asset.on('load', resolve);
                    asset.on('error', reject);
                    app.assets.add(asset);
                    app.assets.load(asset);
                });

                // åˆ›å»ºä½ç½®å®¹å™¨ï¼ˆç”¨äºä½ç½®æ§åˆ¶ï¼Œåœ¨ä¸–ç•Œåæ ‡ç³»ä¸‹ï¼‰
                const pivot = new pc.Entity('pivot');
                pivot.setLocalPosition(config.modelOffsetX, config.modelOffsetY, config.modelOffsetZ);
                app.root.addChild(pivot);
                
                // åˆ›å»ºæ¨¡å‹å®ä½“ï¼ˆç”¨äºæ—‹è½¬æ§åˆ¶ï¼Œåœ¨æœ¬åœ°åæ ‡ç³»ä¸‹ï¼‰
                const splatEntity = new pc.Entity('gsplat');
                splatEntity.addComponent('gsplat', { asset });
                splatEntity.setLocalEulerAngles(config.modelRotationX, config.modelRotationY, config.modelRotationZ);
                pivot.addChild(splatEntity);

                loadingEl.classList.add('hidden');

                // å­˜å‚¨å®ä¾‹
                const instance = {
                    app,
                    camera,
                    pivot,  // ä½ç½®å®¹å™¨
                    splatEntity,  // æ—‹è½¬å®ä½“
                    container,
                    orbitAngles: { pitch: 0, yaw: 0 },
                    targetAngles: { pitch: 0, yaw: 0 },
                    scrollOffset: { pitch: 0 }
                };
                instances[index] = instance;

                // æ›´æ–°å¾ªç¯
                app.on('update', (dt) => updateInstance(instance, dt));

                // é¼ æ ‡æ‚¬åœè§†å·®
                canvas.addEventListener('mousemove', (e) => {
                    if (!config.gyroEnabled) {
                        const rect = canvas.getBoundingClientRect();
                        const x = (e.clientX - rect.left) / rect.width - 0.5;
                        const y = (e.clientY - rect.top) / rect.height - 0.5;
                        instance.targetAngles.yaw = x * 25 * config.parallaxIntensity;
                        instance.targetAngles.pitch = -y * 15 * config.parallaxIntensity;
                    }
                });

                canvas.addEventListener('mouseleave', () => {
                    if (!config.gyroEnabled) {
                        instance.targetAngles.yaw = 0;
                        instance.targetAngles.pitch = 0;
                    }
                });

            } catch (error) {
                console.error(`æ¨¡å‹ ${index} åŠ è½½å¤±è´¥:`, error);
                loadingEl.innerHTML = `<div style="color:#ff5252">åŠ è½½å¤±è´¥</div>`;
            }
        }

        // æ›´æ–°å•ä¸ªå®ä¾‹
        function updateInstance(instance, dt) {
            if (!instance) return;

            // åˆå¹¶æ‰€æœ‰è§’åº¦åç§»
            let finalPitch = instance.targetAngles.pitch + instance.scrollOffset.pitch + config.basePitch;
            let finalYaw = instance.targetAngles.yaw + config.baseYaw;

            // å¦‚æœå¯ç”¨é™€èºä»ªï¼Œä½¿ç”¨é™€èºä»ªæ•°æ®
            if (config.gyroEnabled) {
                finalPitch = gyroAngles.pitch + instance.scrollOffset.pitch + config.basePitch;
                finalYaw = gyroAngles.yaw + config.baseYaw;
            }

            // å¹³æ»‘è¿‡æ¸¡
            instance.orbitAngles.pitch += (finalPitch - instance.orbitAngles.pitch) * 0.1;
            instance.orbitAngles.yaw += (finalYaw - instance.orbitAngles.yaw) * 0.1;

            // æ›´æ–°ç›¸æœºä½ç½®
            const pitchRad = instance.orbitAngles.pitch * Math.PI / 180;
            const yawRad = instance.orbitAngles.yaw * Math.PI / 180;
            const dist = config.cameraDistance;

            const x = dist * Math.sin(yawRad) * Math.cos(pitchRad);
            const y = dist * Math.sin(pitchRad);
            const z = dist * Math.cos(yawRad) * Math.cos(pitchRad);

            instance.camera.setLocalPosition(x, y, z);
            instance.camera.lookAt(config.modelOffsetX, config.modelOffsetY, config.modelOffsetZ);
            
            // æ›´æ–°ç›¸æœº FOV
            if (instance.camera.camera.fov !== config.cameraFov) {
                instance.camera.camera.fov = config.cameraFov;
            }
        }

        // æ»šåŠ¨è§†å·®
        function updateScrollParallax() {
            instances.forEach((instance, index) => {
                if (!instance) return;

                const rect = instance.container.getBoundingClientRect();
                const viewportHeight = window.innerHeight;
                const elementCenter = rect.top + rect.height / 2;
                const viewportCenter = viewportHeight / 2;
                const position = (elementCenter - viewportCenter) / (viewportHeight / 2);
                const normalizedPos = Math.max(-1, Math.min(1, position));

                instance.scrollOffset.pitch = normalizedPos * 20 * config.scrollParallaxIntensity;
            });
        }

        // é™€èºä»ª
        async function requestGyroPermission() {
            if (!window.DeviceOrientationEvent) {
                alert('æ‚¨çš„è®¾å¤‡ä¸æ”¯æŒé™€èºä»ª');
                return false;
            }

            if (typeof DeviceOrientationEvent.requestPermission === 'function') {
                try {
                    const permission = await DeviceOrientationEvent.requestPermission();
                    if (permission !== 'granted') {
                        alert('é™€èºä»ªæƒé™è¢«æ‹’ç»');
                        return false;
                    }
                    gyroPermissionGranted = true;
                } catch (error) {
                    alert('è¯·æ±‚é™€èºä»ªæƒé™å¤±è´¥');
                    return false;
                }
            } else {
                gyroPermissionGranted = true;
            }

            if (!gyroListenerAdded) {
                window.addEventListener('deviceorientation', handleGyro, true);
                gyroListenerAdded = true;
            }
            return true;
        }

        function handleGyro(e) {
            if (!config.gyroEnabled || e.beta === null) return;

            if (!initialGyro) {
                initialGyro = { beta: e.beta, gamma: e.gamma };
            }

            const deltaBeta = (e.beta - initialGyro.beta) * config.parallaxIntensity;
            const deltaGamma = (e.gamma - initialGyro.gamma) * config.parallaxIntensity;

            gyroAngles.pitch = Math.max(-45, Math.min(45, deltaBeta * 0.5));
            gyroAngles.yaw = deltaGamma * 0.8;
        }

        // UIæ§åˆ¶
        function initControls() {
            // æ›´æ–°æ‰€æœ‰æ¨¡å‹çš„ä½ç½®ï¼ˆé€šè¿‡pivotï¼‰
            function updateAllPositions() {
                instances.forEach(inst => {
                    if (inst?.pivot) {
                        inst.pivot.setLocalPosition(config.modelOffsetX, config.modelOffsetY, config.modelOffsetZ);
                    }
                });
            }
            
            // æ›´æ–°æ‰€æœ‰æ¨¡å‹çš„æ—‹è½¬ï¼ˆé€šè¿‡splatEntityï¼‰
            function updateAllRotations() {
                instances.forEach(inst => {
                    if (inst?.splatEntity) {
                        inst.splatEntity.setLocalEulerAngles(config.modelRotationX, config.modelRotationY, config.modelRotationZ);
                    }
                });
            }
            
            // é™€èºä»ªå¼€å…³
            const gyroToggle = document.getElementById('gyro-toggle');
            gyroToggle.addEventListener('click', async () => {
                if (!config.gyroEnabled) {
                    const success = await requestGyroPermission();
                    if (success) {
                        config.gyroEnabled = true;
                        gyroToggle.classList.add('active');
                        initialGyro = null;
                    }
                } else {
                    config.gyroEnabled = false;
                    gyroToggle.classList.remove('active');
                }
            });

            // è§†å·®å¼ºåº¦
            const parallaxSlider = document.getElementById('parallax-intensity');
            const parallaxValue = document.getElementById('parallax-value');
            parallaxSlider.addEventListener('input', () => {
                config.parallaxIntensity = parseFloat(parallaxSlider.value);
                parallaxValue.textContent = config.parallaxIntensity.toFixed(1);
            });
            
            // æ»šåŠ¨è§†å·®å¼ºåº¦
            const scrollSlider = document.getElementById('scroll-intensity');
            const scrollValue = document.getElementById('scroll-value');
            scrollSlider.addEventListener('input', () => {
                config.scrollParallaxIntensity = parseFloat(scrollSlider.value);
                scrollValue.textContent = config.scrollParallaxIntensity.toFixed(1);
            });

            // ç›¸æœºè·ç¦»
            const distanceSlider = document.getElementById('camera-distance');
            const distanceValue = document.getElementById('distance-value');
            distanceSlider.addEventListener('input', () => {
                config.cameraDistance = parseFloat(distanceSlider.value);
                distanceValue.textContent = config.cameraDistance.toFixed(1);
            });
            
            // ç›¸æœºä¿¯ä»°
            const pitchSlider = document.getElementById('base-pitch');
            const pitchValue = document.getElementById('base-pitch-value');
            pitchSlider.addEventListener('input', () => {
                config.basePitch = parseFloat(pitchSlider.value);
                pitchValue.textContent = config.basePitch + 'Â°';
            });
            
            // ç›¸æœºåèˆª
            const yawSlider = document.getElementById('base-yaw');
            const yawValue = document.getElementById('base-yaw-value');
            yawSlider.addEventListener('input', () => {
                config.baseYaw = parseFloat(yawSlider.value);
                yawValue.textContent = config.baseYaw + 'Â°';
            });
            
            // è§†é‡è§’åº¦FOV
            const fovSlider = document.getElementById('camera-fov');
            const fovValue = document.getElementById('fov-value');
            fovSlider.addEventListener('input', () => {
                config.cameraFov = parseFloat(fovSlider.value);
                fovValue.textContent = config.cameraFov + 'Â°';
            });

            // æ¨¡å‹Xè½´ä½ç½®
            const offsetXSlider = document.getElementById('model-offset-x');
            const offsetXValue = document.getElementById('offset-x-value');
            offsetXSlider.addEventListener('input', () => {
                config.modelOffsetX = parseFloat(offsetXSlider.value);
                offsetXValue.textContent = config.modelOffsetX.toFixed(1);
                updateAllPositions();
            });

            // æ¨¡å‹Yè½´ä½ç½®
            const offsetYSlider = document.getElementById('model-offset-y');
            const offsetYValue = document.getElementById('offset-y-value');
            offsetYSlider.addEventListener('input', () => {
                config.modelOffsetY = parseFloat(offsetYSlider.value);
                offsetYValue.textContent = config.modelOffsetY.toFixed(1);
                updateAllPositions();
            });
            
            // æ¨¡å‹Zè½´ä½ç½®
            const offsetZSlider = document.getElementById('model-offset-z');
            const offsetZValue = document.getElementById('offset-z-value');
            offsetZSlider.addEventListener('input', () => {
                config.modelOffsetZ = parseFloat(offsetZSlider.value);
                offsetZValue.textContent = config.modelOffsetZ.toFixed(1);
                updateAllPositions();
            });
            
            // æ¨¡å‹Xè½´æ—‹è½¬
            const rotXSlider = document.getElementById('model-rotation-x');
            const rotXValue = document.getElementById('rotation-x-value');
            rotXSlider.addEventListener('input', () => {
                config.modelRotationX = parseFloat(rotXSlider.value);
                rotXValue.textContent = config.modelRotationX + 'Â°';
                updateAllRotations();
            });
            
            // æ¨¡å‹Yè½´æ—‹è½¬
            const rotYSlider = document.getElementById('model-rotation-y');
            const rotYValue = document.getElementById('rotation-y-value');
            rotYSlider.addEventListener('input', () => {
                config.modelRotationY = parseFloat(rotYSlider.value);
                rotYValue.textContent = config.modelRotationY + 'Â°';
                updateAllRotations();
            });
            
            // æ¨¡å‹Zè½´æ—‹è½¬
            const rotZSlider = document.getElementById('model-rotation-z');
            const rotZValue = document.getElementById('rotation-z-value');
            rotZSlider.addEventListener('input', () => {
                config.modelRotationZ = parseFloat(rotZSlider.value);
                rotZValue.textContent = config.modelRotationZ + 'Â°';
                updateAllRotations();
            });
            
            // é‡ç½®ç›¸æœºæŒ‰é’®
            document.getElementById('reset-camera').addEventListener('click', () => {
                config.cameraDistance = 3.0;
                config.basePitch = 0;
                config.baseYaw = 0;
                config.cameraFov = 60;
                distanceSlider.value = 3.0;
                pitchSlider.value = 0;
                yawSlider.value = 0;
                fovSlider.value = 60;
                distanceValue.textContent = '3.0';
                pitchValue.textContent = '0Â°';
                yawValue.textContent = '0Â°';
                fovValue.textContent = '60Â°';
            });
            
            // é‡ç½®æ¨¡å‹æŒ‰é’®
            document.getElementById('reset-model').addEventListener('click', () => {
                config.modelOffsetX = 0;
                config.modelOffsetY = 0.3;
                config.modelOffsetZ = 0;
                config.modelRotationX = 180;
                config.modelRotationY = 0;
                config.modelRotationZ = 0;
                offsetXSlider.value = 0;
                offsetYSlider.value = 0.3;
                offsetZSlider.value = 0;
                rotXSlider.value = 180;
                rotYSlider.value = 0;
                rotZSlider.value = 0;
                offsetXValue.textContent = '0.0';
                offsetYValue.textContent = '0.3';
                offsetZValue.textContent = '0.0';
                rotXValue.textContent = '180Â°';
                rotYValue.textContent = '0Â°';
                rotZValue.textContent = '0Â°';
                updateAllPositions();
                updateAllRotations();
            });
            
            // å…¨éƒ¨é‡ç½®æŒ‰é’®
            document.getElementById('reset-all').addEventListener('click', () => {
                document.getElementById('reset-camera').click();
                document.getElementById('reset-model').click();
                config.parallaxIntensity = 1.0;
                config.scrollParallaxIntensity = 1.0;
                parallaxSlider.value = 1.0;
                scrollSlider.value = 1.0;
                parallaxValue.textContent = '1.0';
                scrollValue.textContent = '1.0';
            });
        }

        // çª—å£å¤§å°å˜åŒ–
        function handleResize() {
            instances.forEach(inst => {
                if (inst?.app) {
                    inst.app.resizeCanvas();
                }
            });
        }

        // å¯åŠ¨
        async function start() {
            initControls();
            window.addEventListener('scroll', updateScrollParallax, { passive: true });
            window.addEventListener('resize', handleResize);

            // ä¾æ¬¡åˆ›å»ºæ¨¡å‹å®ä¾‹
            for (let i = 0; i < models.length; i++) {
                await createInstance(i);
            }

            // åˆå§‹æ»šåŠ¨è§†å·®è®¡ç®—
            updateScrollParallax();
        }

        start();
    </script>
</body>
</html>
